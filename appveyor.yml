
# Warning: File generated from ci/appveyor.yml.in

version: 1.5.0.{build}

branches:
  only:
    - master
    - appveyor
    - v1.4-branch

configuration:
    - Release

platform:
    - x64

image: Visual Studio 2019

cache:
    - c:\tools\vcpkg\installed

artifacts:
  - path: build/PhotoBroom-1.5.0-*.exe
    name: PhotoBroom_installer

environment:
    WINFLEXBISON_ARCHIVE: win_flex_bison3-latest.zip

install:
    - git clone --depth 1 --branch v1.0.0 https://github.com/Kicer86/photobroom-dependencies.git
    - mklink /J C:\vcpkg %cd%\photobroom-dependencies\msvc2019_64


before_build:
    - if not exist "%WINFLEXBISON_ARCHIVE%" appveyor DownloadFile "http://downloads.sourceforge.net/project/winflexbison/%WINFLEXBISON_ARCHIVE%"
    - 7z x -y -owinflexbison\ "%WINFLEXBISON_ARCHIVE%" > nul
    - set Path=%CD%\winflexbison;%Path%
    - win_flex --version
    - win_bison --version
    - cmd: cd %APPVEYOR_BUILD_FOLDER%
    - git submodule update --init --recursive
    - cmd: set generator="Visual Studio 16 2019"
    - cmd: set qt_arch=msvc2019_64
    - cmd: set arch=amd64
    - cmd: set USE_QT_VER=5.15
    - cmd: set PATH=C:\Qt\%USE_QT_VER%\%qt_arch%\bin;C:\Program Files\CMake\bin;%PATH%
    - cmd: set CMAKE_PREFIX_PATH=C:/Qt/%USE_QT_VER%/%qt_arch%;c:/projects/install
    - cmd: mkdir build
    - cmd: cd build
    - cmd: cmake -G%generator% -A%platform% -DBUILD_UPDATER=ON -DBUILD_TESTING=OFF -DPHOTO_BROOM_BUILD_ID=%APPVEYOR_BUILD_NUMBER% -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake ..

build:
  project: build/PhotoBroom.sln
  parallel: true
  verbosity: minimal

after_build:
    - if "%CONFIGURATION%" == "Release"
         cmake --build . --target deploy  --config %configuration%   &&
         cmake --build . --target PACKAGE --config %configuration%
